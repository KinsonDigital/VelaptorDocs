name: ðŸš€Production API Release
run-name: ðŸš€Production API Release (Velaptor ${{ inputs.api-version }})


defaults:
  run:
    shell: pwsh


on:
  # NOTE: Do not delete this trigger.  This is used by the Velaptor release system 
  workflow_dispatch:
    inputs:
      api-version:
        description: 'The version of API docs to release.'
        required: true
        type: string


jobs:
  validate_branch:
    name: Validate Branch
    runs-on: ubuntu-latest
    steps:
      - name: Run Validation
        run: |
          $branch = "${{ github.ref }}";

          if ($branch -ne "refs/heads/${{ vars.RELEASE_BRANCH }}") {
            Write-Host "::error::This workflow can only be run on the '${{ vars.RELEASE_BRANCH }}' branch.";
            exit 1;
          }


  validate_api_version:
    name: Validate API Version (${{ inputs.api-version }})
    needs: validate_branch
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Validate Syntax
        run: |
          if ("${{ inputs.api-version }}" -notmatch "^v[0-9]+\.[0-9]+\.[0-9]+(|-preview\.[0-9]+)$") {
            Write-Host "::error::The API version '${{ inputs.api-version }}' is not valid.";
            exit 1;
          }

      - name: Set Up Deno
        uses: denoland/setup-deno@v1
        with:
          deno-version: ${{ vars.DENO_VERSION }}

      - name: Validate Version Exists
        run: |
          deno run `
            --allow-net `
            "${{ github.workspace }}/.github/cicd/scripts/velaptor-version-exists.ts" `
            "${{ inputs.api-version }}" `
            "${{ secrets.CICD_TOKEN }}";


  perform_api_release:
    name: Perform API Release
    needs: [validate_branch, validate_api_version]
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write
    concurrency: 
      group: "pages"
      cancel-in-progress: true
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.CICD_TOKEN }}
          persist-credentials: true

      - name: Set Up Deno (${{ vars.DENO_VERSION }})
        uses: denoland/setup-deno@v1
        with:
          deno-version: ${{ vars.DENO_VERSION }}

      # This sdk version SHOULD be the same as the version set in the Velaptor project
      - name: Setup dotnet (${{ vars.VELAPTOR_DOTNET_SDK_VERSION }})
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: ${{ vars.VELAPTOR_DOTNET_SDK_VERSION }}

      - name: Setup Node (${{ vars.NODE_VERSION }})
        uses: actions/setup-node@v4
        with:
          node-version: ${{ vars.NODE_VERSION }}

      - name: Setup PNPM (${{ vars.PNPM_VERSION }})
        uses: pnpm/action-setup@v2
        with:
          version: ${{ vars.PNPM_VERSION }}
    
      # Move the 'next-versioning.ts' to scripts folder
      - name: Disable Next Version Feature
        run: |
          deno run --allow-read --allow-write `
            "${{ github.workspace }}/.github/cicd/manual-testing/next-versioning.ts" `
            "${{ github.workspace }}/docusaurus.config.js" `
            "next-version" `
            "enable";

      - name: Remove Oldest API Version
        run: |
          deno run --allow-read --allow-write `
            "${{ github.workspace }}/.github/cicd/scripts/delete-oldest-api-docs.ts";

      - name: Generate API Docs (${{ inputs.api-version }})
        run: |
          deno run `
            --allow-read --allow-write --allow-run --allow-net `
            "${{ github.workspace }}/.github/cicd/scripts/generate-new-api-docs.ts" `
            "${{ github.workspace }}/docs/api" `
            "${{ inputs.api-version }}" `
            "${{ secrets.CICD_TOKEN }}";

      - name: Install Dependencies (pnpm)
        run: pnpm install;

      - name: Create Docusaurus Version (${{ inputs.api-version }})
        run: |
          $version = "${{ inputs.api-version }}";
          $version = $version.StartsWith("v") ? $version.Substring(1) : $version;
          pnpm docusaurus docs:version $version;

      - name: Update Website Version
        id: apply_version_to_site
        run: |
          # Get the path to the output file created by the GitHub hosted runner
          $outputFilePath = $env:GITHUB_OUTPUT;

          if ($outputFilePath -eq "") {
            Write-Host "::error::Failed to get output file path from the 'GITHUB_OUTPUT' environment variable.";
            exit 1;
          }

          Write-Host "::notice::Output File Path: $outputFilePath";

          # NOTE: The script executed below sets the step output.  This is why the output file
          # path is passed in as an argument using the '$outputFilePath' variable.
          deno run --allow-read --allow-write --allow-env `
            "${{ github.workspace }}/.github/cicd/scripts/update-website-version.ts" `
            "$outputFilePath";
  
      - name: Build Site
        run: pnpm build
  
      - name: Setup Pages
        uses: actions/configure-pages@v3
  
      - name: Upload Artifact
        uses: actions/upload-pages-artifact@v2.0.0
        with:
          path: "${{ github.workspace }}/${{ vars.RELATIVE_ARTIFACT_DIR_PATH }}"
  
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v2
  
      - name: Commit New Docs & Create Release Tag (${{ steps.apply_version_to_site.outputs.version }})
        run: |
          $apiVersion = "${{ inputs.api-version }}";

          # Add the letter 'v' if it is missing
          $apiVersion = $apiVersion.StartsWith("v") ? $apiVersion : "v" + $apiVersion;
          
          $tag = "${{ steps.apply_version_to_site.outputs.version }}";

          git config --global user.email "${{ vars.GIT_CONFIG_EMAIL }}";
          git config --global user.name "Velaptor Docs Github Actions - (On behalf of Calvin Wilkinson)"; 

          git add -A;
          git commit -m "ðŸš€API Doc Release (Velaptor Version ${{ inputs.api-version }})";
          git push;

          git tag -a $tag -m "API Doc Release Version $apiVersion";
          git push origin $tag;
