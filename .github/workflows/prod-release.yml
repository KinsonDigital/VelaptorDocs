name: ðŸš€Production Release


defaults:
  run:
    shell: pwsh


on:
  workflow_dispatch:


permissions:
  contents: write
  pages: write
  id-token: write


jobs:
  validate_branch:
    name: Validate Branch
    runs-on: ubuntu-latest
    steps:
      - name: Run Validation
        run: |
          $branch = "${{ github.ref }}";

          if ($branch -ne "refs/heads/${{ vars.RELEASE_BRANCH }}") {
            Write-Host "::error::This workflow can only be run on the '${{ vars.RELEASE_BRANCH }}' branch.";
            exit 1;
          }


  update_and_get_website_version:
    name: Update And Get Website Version
    uses: ./.github/workflows/update-get-version.yml


  disable_next_version_feature:
    name: Disable Next Version Feature
    needs: [validate_branch, update_and_get_website_version]
    runs-on: ubuntu-latest
    steps:
      - name:  Checkout Repository
        uses: actions/checkout@v3

      - name: Setup Deno (${{ vars.DENO_VERSION }})
        uses: denoland/setup-deno@v1
        with:
          deno-version: ${{ vars.DENO_VERSION }}
      
      - name: Disable Next Version Feature
        run: |
          deno run `
            --allow-read `
            --allow-write `
            "${{ github.workspace }}/.github/cicd/manual-testing/next-versioning.ts" `
            "${{ github.workspace }}/docusaurus.config.js" `
            "next-version" `
            "enable";


  get_artifact_dir_path:
    name: Get Artifact Dir Path
    needs: [validate_branch, update_and_get_website_version, disable_next_version_feature]
    runs-on: ubuntu-latest
    outputs:
      artifact-dir-path: ${{ steps.get-artifact-dir-path.outputs.artifact-dir-path }}
    steps:
      - name: Get Dir Path
        id: get-artifact-dir-path
        run: |
          "artifact-dir-path=${{ github.workspace }}/${{ vars.RELATIVE_ARTIFACT_DIR_PATH }}" >> $env:GITHUB_OUTPUT;


  release_website:
    name: Release Website (${{ needs.update_and_get_website_version.outputs.version }})
    needs: [validate_branch, update_and_get_website_version, disable_next_version_feature, get_artifact_dir_path]
    uses: KinsonDigital/Infrastructure/.github/workflows/docusaurus-release.yml@v12.1.0
    with:
      node-version: "${{ vars.NODE_VERSION }}"
      artifact-dir-path: "${{ needs.get_artifact_dir_path.outputs.artifact-dir-path }}"
      release-version: "${{ needs.update_and_get_website_version.outputs.version }}"
      git-config-email: "${{ vars.GIT_CONFIG_EMAIL }}"
      git-config-name: 'Velaptor Docs Github Actions - (On behalf of Calvin Wilkinson)'
      runs-on: "ubuntu-latest"
      environment-name: "github-pages"
      tag-message: "API Doc Release"
